<?php
set_time_limit(600);
session_start();
require_once __DIR__ . '/../config/database.php';

// Verificação de autenticação e função de acesso
if (!isset($_SESSION['user_id']) || !isset($_SESSION['user_role']) || $_SESSION['user_role'] !== 'admin') {
    header('Location: /login.php');
    exit;
}

// --- Funções de Autenticação e Configuração ---
// Lembre-se de ATUALIZAR este valor no Hotmart Developers se ele expirar ou estiver incorreto.
define('HOTMART_BASIC_AUTH', 'Basic N2UzZDM0MmQtYWY0Zi00MTkwLTk1OWMtNmE5NzU0NmYxNDM3OjZmNjI1NzZmLTQzMzUtNDBkMC04N2FhLThhNThmMDlkZjdmZA==');
// Host de Token (funciona)
define('HOTMART_ACCESS_TOKEN_URL', 'https://api-sec-vlc.hotmart.com/security/oauth/token');
// Host de Dados (Melhor opção após testes de conexão)
define('HOTMART_API_BASE_URL', 'https://developers.hotmart.com'); 
$hotmart_club_subdomain = 'assinaturapremiumplustranslato';

/**
 * Obtém o token de acesso da Hotmart usando Basic Auth.
 * @return string|false Token de acesso ou false em caso de falha.
 */
function get_hotmart_access_token() {
    $ch = curl_init(HOTMART_ACCESS_TOKEN_URL);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true, CURLOPT_POST => 1,
        CURLOPT_POSTFIELDS => http_build_query(['grant_type' => 'client_credentials']),
        CURLOPT_HTTPHEADER => [
            'Authorization: ' . HOTMART_BASIC_AUTH, 
            'Content-Type: application/x-www-form-urlencoded'
        ],
        CURLOPT_CONNECTTIMEOUT => 10,
        CURLOPT_TIMEOUT => 30
    ]);
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($http_code === 200) {
        $data = json_decode($response, true);
        return $data['access_token'] ?? false;
    }
    
    if ($http_code === 400 || $http_code === 401) {
        die("<h2>Erro de Credencial (Basic Auth)</h2><p>O servidor Hotmart rejeitou o Basic Auth. Verifique se a chave de Basic Auth (Client ID:Secret) em seu código está correta e atualizada.</p>");
    }
    
    error_log("Hotmart Token Error: HTTP $http_code | Response: " . $response);
    return false;
}

/**
 * Obtém a lista de lições/páginas do Hotmart Club.
 * @param string $access_token Token de acesso Hotmart.
 * @param string $hotmart_club_subdomain Subdomínio do Club.
 * @return array|false Lista de lições ou false em caso de falha.
 */
function get_hotmart_lessons_hotclub($access_token, $hotmart_club_subdomain) {
    // Usando o endpoint V2 (o mais moderno, que teve sucesso na conexão)
    $api_url = HOTMART_API_BASE_URL . "/hotclub/rest/v2/page/list?subdomain=" . urlencode($hotmart_club_subdomain);

    $ch = curl_init($api_url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true, 
        CURLOPT_CUSTOMREQUEST => 'GET',
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $access_token, 
            'Content-Type: application/json'
        ],
        CURLOPT_CONNECTTIMEOUT => 15,
        CURLOPT_TIMEOUT => 60,
        CURLOPT_FOLLOWLOCATION => true, 
        CURLOPT_MAXREDIRS => 5 
    ]);
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curl_error = curl_error($ch);
    $curl_errno = curl_errno($ch);
    curl_close($ch);

    if ($http_code === 200 && $response !== false) {
        return json_decode($response, true);
    }
    
    $error_message = "Código HTTP: $http_code. ";
    
    if ($http_code === 0 && $curl_errno !== 0) {
        $error_message .= "Erro cURL ($curl_errno): $curl_error. ";
    }
    
    die("<h2>Erro de API da Hotmart Club</h2><p>Falha ao buscar lições. " . $error_message . "</p><p>Isso pode indicar um problema com o Token de Acesso, URL da API, subdomínio do Club ou um problema de conectividade/URL. Resposta da API: " . htmlspecialchars($response) . "</p>");
}


// --- Lógica Principal ---

// 1. Obter token
$access_token = get_hotmart_access_token();
if (!$access_token) {
    die("<h2>Erro de Autenticação Hotmart</h2><p>Não foi possível obter o token de acesso da Hotmart. Verifique as credenciais Basic Auth e tente novamente.</p>");
}

// 2. Obter lições da Hotmart Club
$hotmart_lessons_response = get_hotmart_lessons_hotclub($access_token, $hotmart_club_subdomain);

// 3. Processar a resposta e obter as lições da Hotmart
$hotmart_lessons = [];
if (is_array($hotmart_lessons_response)) {
    // A API V2 retorna uma matriz de módulos
    $hotmart_lessons = $hotmart_lessons_response;
}

// 4. Obter lições locais já mapeadas do BD
try {
    // Busca todos os hotmart_page_id que JÁ estão mapeados em lectures
    $stmt = $pdo->query("SELECT hotmart_page_id FROM lectures WHERE hotmart_page_id IS NOT NULL");
    $mapped_lessons_db = $stmt->fetchAll(PDO::FETCH_COLUMN); 
    $mapped_page_ids = array_map('strval', $mapped_lessons_db);
} catch (PDOException $e) {
    die("Erro ao consultar o banco de dados para lições mapeadas: " . $e->getMessage());
}

// 5. Filtrar lições da Hotmart Club que AINDA NÃO estão mapeadas
$unmapped_lessons = [];
$total_pages_count = 0; // Contagem total de aulas na Hotmart (mapeadas + não mapeadas)

if (is_array($hotmart_lessons)) {
    foreach ($hotmart_lessons as $module) {
        if (isset($module['pages']) && is_array($module['pages'])) {
            foreach ($module['pages'] as $lesson) {
                $total_pages_count++;
                
                $page_id = (string)($lesson['pageId'] ?? null);
                $lesson_title = $lesson['title'] ?? 'Título Desconhecido';
                $lesson_code = (string)($lesson['lessonCode'] ?? $page_id); 

                // Se tiver page_id E não estiver na lista de IDs já mapeados
                if ($page_id && !in_array($page_id, $mapped_page_ids)) {
                    $unmapped_lessons[] = [
                        'module_id' => (string)($module['id'] ?? 'N/A'),
                        'title' => $lesson_title,
                        'page_id' => $page_id,
                        'lesson_id' => $lesson_code 
                    ];
                }
            }
        }
    }
}


// 6. Obter lições locais para o dropdown (aquelas sem mapeamento hotmart)
// Estas são as aulas para as quais você criará o mapeamento.
try {
    $stmt = $pdo->query("SELECT id, title FROM lectures WHERE hotmart_page_id IS NULL ORDER BY title ASC");
    $local_lectures = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("Erro ao consultar o banco de dados para lições locais: " . $e->getMessage());
}

// HTML DE EXIBIÇÃO
$page_title = "Mapeamento Manual de Aulas Hotmart";
?>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title><?php echo htmlspecialchars($page_title); ?></title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #004d40; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { 
            padding: 10px 15px; background-color: #4db6ac; color: white; border: none; 
            border-radius: 4px; cursor: pointer; transition: background-color 0.3s;
        }
        button:hover { background-color: #004d40; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .loading { background-color: #ff9800; }
        .saved-row { background-color: #e0f7fa !important; }
        .alert-message { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .alert-info { background-color: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .alert-warning { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; }
    </style>
</head>
<body>

<div class="container">
    <h1><?php echo htmlspecialchars($page_title); ?></h1>

    <?php if ($total_pages_count === 0): ?>
        <div class="alert-warning alert-message">
            A API da Hotmart retornou dados, mas a lista de páginas/aulas está vazia (<?php echo count($hotmart_lessons); ?> módulos no nível superior). Isso indica que **o subdomínio** (<?php echo htmlspecialchars($hotmart_club_subdomain); ?>) ou a **validade da Basic Auth** estão incorretos para o produto no Club.
        </div>
    <?php elseif (empty($unmapped_lessons)): ?>
        <div class="alert-info alert-message">
            ✓ Todas as lições da Hotmart Club parecem estar mapeadas no seu banco de dados. Total de lições na Hotmart: <?php echo $total_pages_count; ?>.
        </div>
    <?php else: ?>
        <h2>Lições da Hotmart não mapeadas (Total: <?php echo count($unmapped_lessons); ?>)</h2>
        <p>Associe cada lição Hotmart à sua respectiva palestra local (palestras sem *ID da Página Hotmart*).</p>
        
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Lição Hotmart (Título Club)</th>
                        <th>ID da Página Hotmart</th>
                        <th>Lição Local para Mapear</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($local_lectures)): ?>
                        <tr>
                            <td colspan="4" style="text-align: center;" class="alert-warning">
                                Não há palestras locais disponíveis no seu BD para mapeamento (coluna 'hotmart_page_id' está NULL). Crie as palestras na tabela `lectures` primeiro.
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($unmapped_lessons as $lesson): ?>
                            <tr>
                                <td><?php echo htmlspecialchars($lesson['title']); ?></td>
                                <td><?php echo htmlspecialchars($lesson['page_id']); ?></td>
                                <td>
                                    <select name="local_lecture_id">
                                        <option value="">-- Selecione a Palestra Local --</option>
                                        <?php foreach ($local_lectures as $local): ?>
                                            <option value="<?php echo htmlspecialchars($local['id']); ?>">
                                                <?php echo htmlspecialchars($local['title']); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td>
                                    <button 
                                        onclick="saveMapping(this)"
                                        data-hotmart-page-id="<?php echo htmlspecialchars($lesson['page_id']); ?>"
                                        data-hotmart-lesson-id="<?php echo htmlspecialchars($lesson['lesson_id']); ?>"
                                        data-hotmart-module-id="<?php echo htmlspecialchars($lesson['module_id']); ?>"
                                        data-hotmart-title="<?php echo htmlspecialchars($lesson['title']); ?>"
                                    >
                                        Salvar Mapeamento
                                    </button>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    <?php endif; ?>
</div>

<script>
function saveMapping(button) {
    const row = button.closest('tr');
    const select = row.querySelector('select');
    const localId = select.value;

    if (!localId) {
        alert('Por favor, selecione uma palestra local para associar.');
        return;
    }

    button.disabled = true;
    button.classList.add('loading');

    const formData = new FormData();
    formData.append('hotmart_page_id', button.dataset.hotmartPageId);
    formData.append('hotmart_lesson_id', button.dataset.hotmartLessonId);
    formData.append('hotmart_module_id', button.dataset.hotmartModuleId);
    formData.append('hotmart_title', button.dataset.hotmartTitle);
    formData.append('lecture_id', localId);

    // NOTA: O script espera uma API REST em 'save_mapping.php' para processar o mapeamento.
    fetch('save_mapping.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = 'Salvo!';
            row.classList.add('saved-row');
            // Desativa a lista após salvar para evitar novos cliques
            select.disabled = true; 
        } else {
            alert('Erro: ' + data.message);
            button.disabled = false;
            button.classList.remove('loading');
        }
    })
    .catch(error => {
        alert('Erro de conexão. Tente novamente.');
        button.disabled = false;
        button.classList.remove('loading');
    });
}
</script>

</body>
</html>